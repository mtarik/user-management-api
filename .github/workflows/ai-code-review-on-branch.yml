name: ğŸ¤– AI Code Review - Nouvelle Branche

on:
  # Se dÃ©clenche sur les Pull Requests
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.java'

  # Se dÃ©clenche Ã  la crÃ©ation d'une branche
  create:

  # Se dÃ©clenche sur tout push (y compris premiÃ¨re fois sur nouvelle branche)
  push:
    branches:
      - '**'  # Toutes les branches
    paths:
      - '**.java'

  # Permet le dÃ©clenchement manuel
  workflow_dispatch:

jobs:
  ai-code-review:
    # Ne s'exÃ©cute que si c'est une branche (pas un tag) ou une PR
    if: github.ref_type == 'branch' || github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ“¦ Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: ğŸ” Identifier les fichiers Java modifiÃ©s
        id: changed-files
        run: |
          # GÃ©rer diffÃ©remment selon le type d'Ã©vÃ©nement
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Pour une PR, comparer avec la branche de base
            git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep '\.java$' > changed_files.txt || true
          else
            # Pour un push ou crÃ©ation de branche, comparer avec main
            BASE_BRANCH="main"
            if git show-ref --verify --quiet refs/remotes/origin/$BASE_BRANCH; then
              git diff --name-only origin/$BASE_BRANCH...${{ github.sha }} | grep '\.java$' > changed_files.txt || true
            else
              # Si main n'existe pas, prendre tous les fichiers Java
              find . -name "*.java" -not -path "*/target/*" -not -path "*/.git/*" > changed_files.txt || true
            fi
          fi

          if [ -s changed_files.txt ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Fichiers Java Ã  analyser :"
            cat changed_files.txt
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âŒ Aucun fichier Java Ã  analyser"
          fi

      - name: â˜• Compilation du projet Java
        if: steps.changed-files.outputs.found == 'true'
        run: |
          if [ -f "pom.xml" ]; then
            echo "ğŸ”¨ Compilation avec Maven..."
            mvn clean compile -B -q || echo "âš ï¸ Avertissement: Erreur de compilation"
          elif [ -f "build.gradle" ]; then
            echo "ğŸ”¨ Compilation avec Gradle..."
            ./gradlew compileJava -q || echo "âš ï¸ Avertissement: Erreur de compilation"
          else
            echo "â„¹ï¸ Aucun systÃ¨me de build dÃ©tectÃ©"
          fi
        continue-on-error: true

      - name: ğŸ” Analyse statique (Checkstyle, PMD)
        if: steps.changed-files.outputs.found == 'true'
        run: |
          if [ -f "pom.xml" ]; then
            echo "ğŸ“‹ ExÃ©cution de Checkstyle..."
            mvn checkstyle:check || echo "âš ï¸ ProblÃ¨mes Checkstyle dÃ©tectÃ©s"
            echo "ğŸ” ExÃ©cution de PMD..."
            mvn pmd:check || echo "âš ï¸ ProblÃ¨mes PMD dÃ©tectÃ©s"
          fi
        continue-on-error: true

      - name: ğŸ Setup Python
        if: steps.changed-files.outputs.found == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Installer les dÃ©pendances Python
        if: steps.changed-files.outputs.found == 'true'
        run: |
          pip install -r scripts/requirements.txt

      - name: ğŸ¤– Analyse IA avec Claude
        if: steps.changed-files.outputs.found == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.repository }}
          COMMIT_SHA: ${{ github.sha }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          echo "ğŸ§  Lancement de l'analyse IA..."
          echo "ğŸ“ Branche: ${{ github.ref_name }}"
          python scripts/ai_code_reviewer.py

      - name: ğŸ“Š Upload du rapport d'analyse
        if: always() && steps.changed-files.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-report-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            code_review_*.md
            code_review_*.json
            review_report.json
            review_report.md
          retention-days: 30

      - name: ğŸ” Trouver la Pull Request associÃ©e
        if: steps.changed-files.outputs.found == 'true'
        id: find-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Si c'est un Ã©vÃ©nement pull_request, on a directement le numÃ©ro
            if (context.eventName === 'pull_request') {
              core.setOutput('pr-number', context.issue.number);
              core.setOutput('has-pr', 'true');
              console.log(`âœ… PR #${context.issue.number}`);
              return;
            }

            // Sinon, chercher une PR ouverte pour cette branche
            const branch = context.ref.replace('refs/heads/', '');
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (pulls.length > 0) {
              core.setOutput('pr-number', pulls[0].number);
              core.setOutput('has-pr', 'true');
              console.log(`âœ… PR trouvÃ©e: #${pulls[0].number}`);
            } else {
              core.setOutput('has-pr', 'false');
              console.log('â„¹ï¸ Aucune PR ouverte pour cette branche');
            }

      - name: ğŸ’¬ Commenter la Pull Request
        if: steps.changed-files.outputs.found == 'true' && steps.find-pr.outputs.has-pr == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Lire le rapport Markdown
            let reportContent = '## ğŸ¤– Revue de Code IA - RÃ©sultats\n\n';

            // Chercher les fichiers de rapport
            const files = fs.readdirSync('.');
            const mdFile = files.find(f => f.startsWith('code_review_') && f.endsWith('.md'));

            if (mdFile && fs.existsSync(mdFile)) {
              reportContent += fs.readFileSync(mdFile, 'utf8');
            } else {
              reportContent += 'âœ… Analyse terminÃ©e. Aucun problÃ¨me majeur dÃ©tectÃ©.';
            }

            // Ajouter un footer
            reportContent += '\n\n---\n';
            reportContent += `ğŸ” Commit: \`${context.sha.substring(0, 7)}\`\n`;
            reportContent += `ğŸŒ¿ Branche: \`${{ github.ref_name }}\`\n`;
            reportContent += `â° AnalysÃ© le: ${new Date().toLocaleString('fr-FR')}\n`;
            reportContent += `ğŸ¤– PropulsÃ© par Claude Sonnet 4.5`;

            // Poster le commentaire
            await github.rest.issues.createComment({
              issue_number: ${{ steps.find-pr.outputs.pr-number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportContent
            });

      - name: âœ… RÃ©sumÃ© de l'analyse
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RÃ‰SUMÃ‰ DE L'ANALYSE IA"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ¿ Branche: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"

          if [ "${{ steps.changed-files.outputs.found }}" == "true" ]; then
            if ls code_review_*.json 1> /dev/null 2>&1; then
              echo "âœ… Revue de code terminÃ©e avec succÃ¨s"
              echo "ğŸ“ Rapport disponible dans les artefacts"
            else
              echo "âš ï¸ Aucun rapport gÃ©nÃ©rÃ©"
            fi
          else
            echo "â„¹ï¸ Aucun fichier Java Ã  analyser"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
