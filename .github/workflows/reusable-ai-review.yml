name: ğŸ¤– Reusable AI Code Review - Java

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Version de Java Ã  utiliser'
        required: false
        type: string
        default: '17'
      build-tool:
        description: 'Outil de build (maven, gradle, ou auto)'
        required: false
        type: string
        default: 'auto'
      enable-static-analysis:
        description: 'Activer Checkstyle, PMD, SpotBugs'
        required: false
        type: boolean
        default: true
      post-pr-comment:
        description: 'Poster un commentaire sur la PR'
        required: false
        type: boolean
        default: true
      fail-on-critical:
        description: 'Ã‰chouer le workflow si problÃ¨mes critiques'
        required: false
        type: boolean
        default: false
    secrets:
      ANTHROPIC_API_KEY:
        description: 'ClÃ© API Anthropic pour Claude (optionnel pour analyse basique)'
        required: false

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'

      - name: ğŸ“¦ Cache Maven
        if: inputs.build-tool == 'maven' || inputs.build-tool == 'auto'
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: ğŸ“¦ Cache Gradle
        if: inputs.build-tool == 'gradle' || inputs.build-tool == 'auto'
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: ğŸ” Identifier les fichiers Java modifiÃ©s
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep '\.java$' > changed_files.txt || true
          else
            git diff --name-only HEAD~1 HEAD | grep '\.java$' > changed_files.txt || true
          fi

          if [ -s changed_files.txt ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Fichiers Java modifiÃ©s :"
            cat changed_files.txt
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun fichier Java modifiÃ©"
          fi

      - name: â˜• Compilation du projet Java
        if: steps.changed-files.outputs.found == 'true'
        run: |
          BUILD_TOOL="${{ inputs.build-tool }}"

          # Auto-dÃ©tection
          if [ "$BUILD_TOOL" == "auto" ]; then
            if [ -f "pom.xml" ]; then
              BUILD_TOOL="maven"
            elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
              BUILD_TOOL="gradle"
            fi
          fi

          # Compilation
          if [ "$BUILD_TOOL" == "maven" ]; then
            echo "ğŸ”¨ Compilation avec Maven..."
            mvn clean compile -B -q || echo "âš ï¸ Avertissement: Erreur de compilation"
          elif [ "$BUILD_TOOL" == "gradle" ]; then
            echo "ğŸ”¨ Compilation avec Gradle..."
            chmod +x gradlew || true
            ./gradlew compileJava -q || echo "âš ï¸ Avertissement: Erreur de compilation"
          else
            echo "â„¹ï¸ Aucun systÃ¨me de build dÃ©tectÃ©"
          fi
        continue-on-error: true

      - name: ğŸ” Analyse statique
        if: steps.changed-files.outputs.found == 'true' && inputs.enable-static-analysis
        run: |
          if [ -f "pom.xml" ]; then
            echo "ğŸ“‹ ExÃ©cution de Checkstyle..."
            mvn checkstyle:check || echo "âš ï¸ ProblÃ¨mes Checkstyle dÃ©tectÃ©s"
            echo "ğŸ” ExÃ©cution de PMD..."
            mvn pmd:check || echo "âš ï¸ ProblÃ¨mes PMD dÃ©tectÃ©s"
          fi
        continue-on-error: true

      - name: ğŸ¤– Analyse des fichiers modifiÃ©s
        if: steps.changed-files.outputs.found == 'true'
        run: |
          echo "ğŸ§  Analyse des fichiers Java modifiÃ©s..."
          echo "# ğŸ¤– Revue de Code IA - Analyse statique" > code_review_report.md
          echo "" >> code_review_report.md
          echo "## Fichiers analysÃ©s" >> code_review_report.md
          echo "" >> code_review_report.md

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "- \`$file\`" >> code_review_report.md

              # VÃ©rifications basiques
              echo "" >> code_review_report.md
              echo "### Analyse de \`$file\`" >> code_review_report.md
              echo "" >> code_review_report.md

              # Recherche de System.out.println
              if grep -q "System\.out\.println\|System\.err\.println" "$file"; then
                echo "âš ï¸ **Avertissement**: Utilisation de \`System.out.println\` dÃ©tectÃ©e. PrivilÃ©gier un logger." >> code_review_report.md
                echo "" >> code_review_report.md
              fi

              # Recherche de printStackTrace
              if grep -q "printStackTrace" "$file"; then
                echo "âš ï¸ **Avertissement**: Utilisation de \`printStackTrace()\` dÃ©tectÃ©e. Utiliser un logger appropriÃ©." >> code_review_report.md
                echo "" >> code_review_report.md
              fi

              # Recherche de comparaisons avec ==
              if grep -q '== "' "$file" || grep -q '" ==' "$file"; then
                echo "ğŸ”´ **Erreur**: Comparaison de String avec \`==\`. Utiliser \`.equals()\`." >> code_review_report.md
                echo "" >> code_review_report.md
              fi

              # Recherche de champs static avec @Autowired
              if grep -q "@Autowired" "$file" && grep -q "static.*Repository" "$file"; then
                echo "ğŸ”´ **Erreur critique**: \`@Autowired\` sur un champ \`static\` dÃ©tectÃ©. Spring ne peut pas injecter dans des champs statiques." >> code_review_report.md
                echo "" >> code_review_report.md
              fi

              # Recherche de System.gc()
              if grep -q "System\.gc()" "$file"; then
                echo "ğŸ”´ **Anti-pattern**: Appel explicite Ã  \`System.gc()\`. Ne devrait jamais Ãªtre utilisÃ©." >> code_review_report.md
                echo "" >> code_review_report.md
              fi

              # Recherche de retours null
              if grep -q "return null" "$file"; then
                echo "âš ï¸ **Avertissement**: Retour de \`null\` dÃ©tectÃ©. PrivilÃ©gier \`Optional\` ou lever une exception." >> code_review_report.md
                echo "" >> code_review_report.md
              fi

              echo "" >> code_review_report.md
            fi
          done < changed_files.txt

          cat code_review_report.md

      - name: ğŸ“Š Upload du rapport
        if: always() && steps.changed-files.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-report-${{ github.sha }}
          path: |
            code_review_report.md
          retention-days: 30

      - name: ğŸ’¬ Commenter la Pull Request
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.found == 'true' && inputs.post-pr-comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let reportContent = '';

            if (fs.existsSync('code_review_report.md')) {
              reportContent = fs.readFileSync('code_review_report.md', 'utf8');
            } else {
              reportContent = '## ğŸ¤– Revue de Code IA - RÃ©sultats\n\n';
              reportContent += 'âœ… Analyse terminÃ©e. Aucun problÃ¨me majeur dÃ©tectÃ©.';
            }

            reportContent += '\n\n---\n';
            reportContent += `ğŸ” Commit: \`${context.sha.substring(0, 7)}\`\n`;
            reportContent += `â° AnalysÃ© le: ${new Date().toLocaleString('fr-FR')}\n`;
            reportContent += `ğŸ¤– Analyse automatisÃ©e par GitHub Actions`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportContent
            });

      - name: ğŸ” VÃ©rifier les problÃ¨mes critiques
        if: steps.changed-files.outputs.found == 'true' && inputs.fail-on-critical
        run: |
          if [ -f "code_review_report.md" ]; then
            CRITICAL_COUNT=$(grep -c "ğŸ”´ \*\*Erreur critique\*\*" code_review_report.md || echo 0)

            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "âŒ $CRITICAL_COUNT problÃ¨me(s) critique(s) dÃ©tectÃ©(s)!"
              exit 1
            fi
          fi

      - name: âœ… RÃ©sumÃ©
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RÃ‰SUMÃ‰ DE L'ANALYSE IA"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "${{ steps.changed-files.outputs.found }}" == "true" ]; then
            if ls code_review_*.json 1> /dev/null 2>&1; then
              echo "âœ… Revue de code terminÃ©e avec succÃ¨s"
              echo "ğŸ“ Rapport disponible dans les artefacts"
            else
              echo "âš ï¸ Aucun rapport gÃ©nÃ©rÃ©"
            fi
          else
            echo "â„¹ï¸ Aucun fichier Java Ã  analyser"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
