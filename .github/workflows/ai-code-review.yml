# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ Workflow de Revue de Code IA v3.0 - Standalone Version
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# âœ¨ FonctionnalitÃ©s v3.0 :
# - ğŸ“Š Scoring dÃ©taillÃ© par catÃ©gorie (/10 avec quality labels)
# - ğŸ”’ Analyse OWASP Top 10 2021 structurÃ©e
# - ğŸ—ï¸ Analyse architecturale approfondie (patterns, violations, couplage)
# - âš¡ Optimisations performance dÃ©taillÃ©es (N+1, caching, complexitÃ©)
# - ğŸ·ï¸ Auto-labelling automatique basÃ© sur l'analyse
# - ğŸš¨ SystÃ¨me de gates (fail-on-critical) pour bloquer les merges
# - ğŸ“ˆ Tracking des mÃ©triques et tendances
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸ¤– AI Code Review v3.0

on:
  # Se dÃ©clenche sur les Pull Requests
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.java'

  # Se dÃ©clenche sur les commits sur ces branches
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'feat/**'
      - 'hotfix/**'
    paths:
      - '**.java'

  # Permet le dÃ©clenchement manuel
  workflow_dispatch:

jobs:
  ai-code-review:
    name: ğŸ“Š Revue de Code IA v3.0
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ“¦ Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: ğŸ” Identifier les fichiers Java modifiÃ©s
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep '\.java$' > changed_files.txt || true
          else
            git diff --name-only HEAD~1 HEAD | grep '\.java$' > changed_files.txt || true
          fi

          if [ -s changed_files.txt ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Fichiers Java modifiÃ©s :"
            cat changed_files.txt
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun fichier Java modifiÃ©"
          fi

      - name: â˜• Compilation du projet Java
        if: steps.changed-files.outputs.found == 'true'
        run: |
          if [ -f "pom.xml" ]; then
            echo "ğŸ”¨ Compilation avec Maven..."
            mvn clean compile -B -q || echo "âš ï¸ Avertissement: Erreur de compilation"
          elif [ -f "build.gradle" ]; then
            echo "ğŸ”¨ Compilation avec Gradle..."
            ./gradlew compileJava -q || echo "âš ï¸ Avertissement: Erreur de compilation"
          else
            echo "â„¹ï¸ Aucun systÃ¨me de build dÃ©tectÃ©"
          fi
        continue-on-error: true

      - name: ğŸ” Analyse statique (Checkstyle, PMD)
        if: steps.changed-files.outputs.found == 'true'
        run: |
          if [ -f "pom.xml" ]; then
            echo "ğŸ“‹ ExÃ©cution de Checkstyle..."
            mvn checkstyle:check || echo "âš ï¸ ProblÃ¨mes Checkstyle dÃ©tectÃ©s"
            echo "ğŸ” ExÃ©cution de PMD..."
            mvn pmd:check || echo "âš ï¸ ProblÃ¨mes PMD dÃ©tectÃ©s"
          fi
        continue-on-error: true

      - name: ğŸ Setup Python
        if: steps.changed-files.outputs.found == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¥ Checkout AI Code Review Agent
        if: steps.changed-files.outputs.found == 'true'
        uses: actions/checkout@v4
        with:
          repository: mtarik/java-ai-code-review
          path: .ai-review-agent
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Copier les scripts de l'agent
        if: steps.changed-files.outputs.found == 'true'
        run: |
          echo "ğŸ“¦ Configuration de l'agent AI Code Review v3.0..."
          mkdir -p scripts/ai_reviewer/providers

          # Copier les fichiers depuis le repo clonÃ©
          cp .ai-review-agent/scripts/ai_code_reviewer.py scripts/
          cp .ai-review-agent/scripts/requirements.txt scripts/
          cp .ai-review-agent/scripts/ai_reviewer/__init__.py scripts/ai_reviewer/
          cp .ai-review-agent/scripts/ai_reviewer/models.py scripts/ai_reviewer/
          cp .ai-review-agent/scripts/ai_reviewer/reviewer.py scripts/ai_reviewer/
          cp .ai-review-agent/scripts/ai_reviewer/report_generator.py scripts/ai_reviewer/
          cp .ai-review-agent/scripts/ai_reviewer/metrics.py scripts/ai_reviewer/
          cp .ai-review-agent/scripts/ai_reviewer/providers/__init__.py scripts/ai_reviewer/providers/
          cp .ai-review-agent/scripts/ai_reviewer/providers/base.py scripts/ai_reviewer/providers/
          cp .ai-review-agent/scripts/ai_reviewer/providers/anthropic_provider.py scripts/ai_reviewer/providers/
          cp .ai-review-agent/scripts/ai_reviewer/providers/system_prompt.py scripts/ai_reviewer/providers/

          echo "âœ… Agent configurÃ© avec succÃ¨s"

      - name: ğŸ“¦ Installer les dÃ©pendances Python
        if: steps.changed-files.outputs.found == 'true'
        run: |
          pip install -r scripts/requirements.txt

      - name: ğŸ¤– Analyse IA avec Claude Sonnet 4.5
        if: steps.changed-files.outputs.found == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "ğŸ§  Lancement de l'analyse IA v3.0..."
          python scripts/ai_code_reviewer.py

      - name: ğŸ“Š Upload du rapport d'analyse
        if: always() && steps.changed-files.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-report-${{ github.sha }}
          path: |
            code_review_*.md
            code_review_*.json
            review_report.json
            review_report.md
            metrics_report.md
          retention-days: 30

      - name: ğŸ’¬ Commenter la Pull Request
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Lire le rapport Markdown
            let reportContent = '## ğŸ¤– Revue de Code IA v3.0 - RÃ©sultats\n\n';

            // Chercher les fichiers de rapport
            const files = fs.readdirSync('.');
            const mdFile = files.find(f => f.startsWith('code_review_') && f.endsWith('.md'));

            if (mdFile && fs.existsSync(mdFile)) {
              reportContent += fs.readFileSync(mdFile, 'utf8');
            } else {
              reportContent += 'âœ… Analyse terminÃ©e. Aucun problÃ¨me majeur dÃ©tectÃ©.';
            }

            // Ajouter un footer
            reportContent += '\n\n---\n';
            reportContent += `ğŸ” Commit: \`${context.sha.substring(0, 7)}\`\n`;
            reportContent += `â° AnalysÃ© le: ${new Date().toLocaleString('fr-FR')}\n`;
            reportContent += `ğŸ¤– PropulsÃ© par Claude Sonnet 4.5 â€¢ AI Code Review v3.0`;

            // Poster le commentaire
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportContent
            });

      - name: ğŸ·ï¸ Auto-labelling de la PR
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Trouver le fichier JSON de revue
            const files = fs.readdirSync('.');
            const jsonFile = files.find(f => f.startsWith('code_review_') && f.endsWith('.json'));

            if (!jsonFile) {
              console.log('âš ï¸ Aucun rapport JSON trouvÃ© pour l\'auto-labelling');
              return;
            }

            const review = JSON.parse(fs.readFileSync(jsonFile, 'utf8'));
            const labels = new Set();

            // Analyser les issues pour dÃ©terminer les labels
            let criticalCount = 0;
            let securityCount = 0;
            let performanceCount = 0;
            let architectureCount = 0;

            review.files?.forEach(file => {
              file.issues?.forEach(issue => {
                if (issue.severity === 'critical') {
                  criticalCount++;
                  labels.add('ai-review:critical');
                }

                const category = issue.category?.toLowerCase() || '';
                if (category.includes('security') || category.includes('sÃ©curitÃ©')) {
                  securityCount++;
                  labels.add('ai-review:security');
                } else if (category.includes('performance')) {
                  performanceCount++;
                  labels.add('ai-review:performance');
                } else if (category.includes('architecture')) {
                  architectureCount++;
                  labels.add('ai-review:architecture');
                }

                // Labels OWASP si applicable
                if (issue.owasp_category) {
                  labels.add('ai-review:owasp');
                }
              });
            });

            // Ajouter un label de score basÃ© sur overall_score (0-10)
            const score = review.overall_score || 0;
            if (score >= 9) {
              labels.add('ai-review:excellent');
            } else if (score >= 7) {
              labels.add('ai-review:good');
            } else if (score >= 5) {
              labels.add('ai-review:acceptable');
            } else {
              labels.add('ai-review:needs-work');
            }

            // Label de qualitÃ©
            if (review.quality_label) {
              labels.add(`quality:${review.quality_label.toLowerCase().replace(/\s+/g, '-')}`);
            }

            console.log(`ğŸ“Š Analyse: ${criticalCount} critiques, ${securityCount} sÃ©curitÃ©, ${performanceCount} performance, ${architectureCount} architecture`);
            console.log(`ğŸ·ï¸ Labels Ã  ajouter: ${Array.from(labels).join(', ')}`);

            // DÃ©finir les couleurs des labels
            const labelColors = {
              'ai-review:critical': 'b60205',
              'ai-review:security': 'd93f0b',
              'ai-review:owasp': 'c5def5',
              'ai-review:performance': 'fbca04',
              'ai-review:architecture': '0e8a16',
              'ai-review:excellent': '0e8a16',
              'ai-review:good': 'a2eeef',
              'ai-review:acceptable': 'fbca04',
              'ai-review:needs-work': 'd93f0b',
              'quality:excellent-code-review': '0e8a16',
              'quality:good-code-review': 'a2eeef',
              'quality:acceptable-code-review': 'fbca04',
              'quality:needs-work': 'd93f0b'
            };

            const labelDescriptions = {
              'ai-review:critical': 'ProblÃ¨mes critiques dÃ©tectÃ©s par IA',
              'ai-review:security': 'ProblÃ¨mes de sÃ©curitÃ© dÃ©tectÃ©s',
              'ai-review:owasp': 'VulnÃ©rabilitÃ©s OWASP Top 10',
              'ai-review:performance': 'Optimisations de performance suggÃ©rÃ©es',
              'ai-review:architecture': 'ProblÃ¨mes architecturaux',
              'ai-review:excellent': 'Score IA excellent (9-10/10)',
              'ai-review:good': 'Bon score IA (7-8/10)',
              'ai-review:acceptable': 'Score IA acceptable (5-6/10)',
              'ai-review:needs-work': 'NÃ©cessite du travail (0-4/10)',
              'quality:excellent-code-review': 'QualitÃ© excellente',
              'quality:good-code-review': 'Bonne qualitÃ©',
              'quality:acceptable-code-review': 'QualitÃ© acceptable',
              'quality:needs-work': 'QualitÃ© Ã  amÃ©liorer'
            };

            // RÃ©cupÃ©rer les labels existants du repo
            let existingLabels = [];
            try {
              const response = await github.rest.issues.listLabelsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              existingLabels = response.data.map(l => l.name);
            } catch (error) {
              console.log('âš ï¸ Erreur lors de la rÃ©cupÃ©ration des labels:', error.message);
            }

            // CrÃ©er les labels manquants
            for (const label of labels) {
              if (!existingLabels.includes(label)) {
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label,
                    color: labelColors[label] || 'ededed',
                    description: labelDescriptions[label] || 'Auto-gÃ©nÃ©rÃ© par AI Code Review'
                  });
                  console.log(`âœ… Label crÃ©Ã©: ${label}`);
                } catch (error) {
                  if (error.status !== 422) {
                    console.log(`âš ï¸ Impossible de crÃ©er le label ${label}:`, error.message);
                  }
                }
              }
            }

            // Appliquer les labels Ã  la PR
            if (labels.size > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: Array.from(labels)
                });
                console.log(`âœ… ${labels.size} label(s) ajoutÃ©(s) Ã  la PR`);
              } catch (error) {
                console.log('âš ï¸ Erreur lors de l\'ajout des labels:', error.message);
              }
            } else {
              console.log('â„¹ï¸ Aucun label Ã  ajouter');
            }

      - name: âœ… RÃ©sumÃ© de l'analyse
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RÃ‰SUMÃ‰ DE L'ANALYSE IA v3.0"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "${{ steps.changed-files.outputs.found }}" == "true" ]; then
            if ls code_review_*.json 1> /dev/null 2>&1; then
              echo "âœ… Revue de code terminÃ©e avec succÃ¨s"
              echo "ğŸ“ Rapport disponible dans les artefacts"
            else
              echo "âš ï¸ Aucun rapport gÃ©nÃ©rÃ©"
            fi
          else
            echo "â„¹ï¸ Aucun fichier Java Ã  analyser"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
