# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ Workflow de Revue de Code IA - Appelle le workflow centralisÃ©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸ¤– AI Code Review

on:
  # Se dÃ©clenche sur les Pull Requests
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.java'

  # Se dÃ©clenche sur les commits sur ces branches
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'feat/**'
      - 'hotfix/**'
    paths:
      - '**.java'

  # Permet le dÃ©clenchement manuel
  workflow_dispatch:

jobs:
  call-ai-review:
    name: ğŸ“Š Analyse IA du code Java
    permissions:
      contents: read
      pull-requests: write
      issues: write
    uses: mtarik/java-ai-code-review/.github/workflows/reusable-ai-review.yml@main

    with:
      # Version de Java (17, 11, 8, etc.)
      java-version: '17'

      # Outil de build: 'auto', 'maven', ou 'gradle'
      build-tool: 'auto'

      # Activer les analyses statiques (Checkstyle, PMD)
      enable-static-analysis: true

      # Poster un commentaire sur la Pull Request
      post-pr-comment: true

      # Ã‰chouer le workflow si des problÃ¨mes critiques sont dÃ©tectÃ©s
      fail-on-critical: false

    secrets:
      # La clÃ© API Anthropic doit Ãªtre configurÃ©e dans les secrets du repository
      # Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
      # Nom: ANTHROPIC_API_KEY
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  summary:
    name: ğŸ“‹ RÃ©sumÃ© de l'Analyse
    needs: call-ai-review
    if: github.event_name == 'pull_request' && always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout pour analyser les fichiers
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š Analyser les fichiers modifiÃ©s
        id: analysis
        run: |
          # Compter les fichiers Java modifiÃ©s
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            JAVA_FILES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep '\.java$' | wc -l)
          else
            JAVA_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.java$' | wc -l)
          fi

          echo "java_files=$JAVA_FILES" >> $GITHUB_OUTPUT

      - name: ğŸ’¬ Poster rÃ©sumÃ©
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const javaFiles = '${{ steps.analysis.outputs.java_files }}';

            const reportContent = '### ğŸ¤– RÃ©sumÃ© de l\'Analyse IA\n\n' +
              '**Fichiers analysÃ©s:** ' + javaFiles + ' fichiers Java modifiÃ©s\n' +
              '**Revue IA:** ğŸ” Commentaires dÃ©taillÃ©s dans "Files changed"\n\n' +
              '_ğŸ“ Rapports complets dans les artefacts du workflow_';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportContent
            });
