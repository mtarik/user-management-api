# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ Workflow de Revue de Code IA - Appelle le workflow centralisÃ©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸ¤– AI Code Review

on:
  # Se dÃ©clenche sur les Pull Requests
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.java'

  # Se dÃ©clenche sur les commits sur ces branches
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'feat/**'
      - 'hotfix/**'
    paths:
      - '**.java'

  # Permet le dÃ©clenchement manuel
  workflow_dispatch:

jobs:
  test-coverage:
    name: ğŸ§ª Tests & Couverture
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ“¦ Cache Maven
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: ğŸ§ª ExÃ©cuter les tests avec couverture
        run: |
          echo "ğŸ§ª ExÃ©cution des tests unitaires et d'intÃ©gration..."
          mvn clean test jacoco:report -B
        continue-on-error: false

      - name: ğŸ“Š Analyser les rÃ©sultats des tests
        if: always()
        run: |
          echo "# ğŸ§ª Rapport de Tests et Couverture" > test-report.md
          echo "" >> test-report.md

          # Extraire les statistiques des tests
          if [ -f "target/surefire-reports/TEST-*.xml" ]; then
            TOTAL_TESTS=$(grep -r "tests=" target/surefire-reports/TEST-*.xml | sed 's/.*tests="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            FAILURES=$(grep -r "failures=" target/surefire-reports/TEST-*.xml | sed 's/.*failures="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            ERRORS=$(grep -r "errors=" target/surefire-reports/TEST-*.xml | sed 's/.*errors="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            SKIPPED=$(grep -r "skipped=" target/surefire-reports/TEST-*.xml | sed 's/.*skipped="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')

            SUCCESS=$((TOTAL_TESTS - FAILURES - ERRORS - SKIPPED))

            echo "## ğŸ“ˆ RÃ©sultats des Tests" >> test-report.md
            echo "" >> test-report.md
            echo "| MÃ©trique | Valeur |" >> test-report.md
            echo "|----------|--------|" >> test-report.md
            echo "| âœ… Tests rÃ©ussis | $SUCCESS / $TOTAL_TESTS |" >> test-report.md
            echo "| âŒ Tests Ã©chouÃ©s | $FAILURES |" >> test-report.md
            echo "| âš ï¸ Erreurs | $ERRORS |" >> test-report.md
            echo "| â­ï¸ Tests ignorÃ©s | $SKIPPED |" >> test-report.md
            echo "" >> test-report.md

            if [ $FAILURES -eq 0 ] && [ $ERRORS -eq 0 ]; then
              echo "âœ… **Tous les tests passent avec succÃ¨s !**" >> test-report.md
            else
              echo "âŒ **Attention: Des tests ont Ã©chouÃ©**" >> test-report.md
            fi
            echo "" >> test-report.md
          fi

          # Analyser la couverture JaCoCo
          if [ -f "target/site/jacoco/index.html" ]; then
            echo "## ğŸ“Š Couverture de Code (JaCoCo)" >> test-report.md
            echo "" >> test-report.md

            # Extraire les statistiques de couverture
            INSTRUCTION_COVERAGE=$(grep -A 1 "Total" target/site/jacoco/index.html | grep -oP '\d+%' | head -1 || echo "N/A")
            BRANCH_COVERAGE=$(grep -A 1 "Total" target/site/jacoco/index.html | grep -oP '\d+%' | sed -n '2p' || echo "N/A")

            echo "| Type de Couverture | Taux |" >> test-report.md
            echo "|-------------------|------|" >> test-report.md
            echo "| Instructions | $INSTRUCTION_COVERAGE |" >> test-report.md
            echo "| Branches | $BRANCH_COVERAGE |" >> test-report.md
            echo "" >> test-report.md

            echo "ğŸ“ **Rapport dÃ©taillÃ© disponible dans les artefacts**" >> test-report.md
          fi

          cat test-report.md

      - name: ğŸ“Š Upload rapport de couverture
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.sha }}
          path: |
            target/site/jacoco/
            target/surefire-reports/
          retention-days: 30

      - name: ğŸ’¬ Commenter la PR avec les rÃ©sultats
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let reportContent = '';

            if (fs.existsSync('test-report.md')) {
              reportContent = fs.readFileSync('test-report.md', 'utf8');
            } else {
              reportContent = '## ğŸ§ª Rapport de Tests\n\nâš ï¸ Impossible de gÃ©nÃ©rer le rapport';
            }

            reportContent += '\n\n---\n';
            reportContent += `ğŸ” Commit: \`${context.sha.substring(0, 7)}\`\n`;
            reportContent += `â° AnalysÃ© le: ${new Date().toLocaleString('fr-FR')}\n`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportContent
            });

  call-ai-review:
    name: ğŸ“Š Analyse IA du code Java
    needs: test-coverage
    permissions:
      contents: read
      pull-requests: write
      issues: write
    uses: mtarik/java-ai-code-review/.github/workflows/reusable-ai-review.yml@main

    with:
      # Version de Java (17, 11, 8, etc.)
      java-version: '17'

      # Outil de build: 'auto', 'maven', ou 'gradle'
      build-tool: 'auto'

      # Activer les analyses statiques (Checkstyle, PMD)
      enable-static-analysis: true

      # Poster un commentaire sur la Pull Request
      post-pr-comment: true

      # Ã‰chouer le workflow si des problÃ¨mes critiques sont dÃ©tectÃ©s
      fail-on-critical: false

    secrets:
      # La clÃ© API Anthropic doit Ãªtre configurÃ©e dans les secrets du repository
      # Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
      # Nom: ANTHROPIC_API_KEY
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
